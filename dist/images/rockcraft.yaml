# Instructions: Go compiled binaries are expected to be in the dist/images folder
# use Rockcraft to generate the .rock and skopeo to load it into a local Docker daemon or a registry
# make bld
# rockcraft pack
# sudo rockcraft.skopeo --insecure-policy copy oci-archive:ovn-kubernetes_latest_amd64.rock docker-daemon:ovn-kubernetes:latest

name: ovn-kubernetes
summary: OVN Kubernetes CNI
description: Rock image including all binaries required for any OVN-Kubernetes container
version: "latest"
license: Apache-2.0

base: ubuntu@24.04
build-base: ubuntu@24.04
platforms:
  amd64: # Make sure this value matches your computer's architecture

parts:
  tools:
    plugin: nil
    stage-packages:
      - iproute2
      - curl
      - software-properties-common
      - util-linux
      - nftables
      - libmnl0

  ovn:
    plugin: nil
    stage-packages:
      - ovn-central
      - ovn-common
      - ovn-host

  ovs:
    plugin: nil
    stage-packages:
      - openvswitch-switch
      - openvswitch-common
    override-prime: |
      ln -sf /usr/lib/openvswitch-switch/ovs-vswitchd usr/bin/ovs-vswitchd

  kubectl:
    plugin: nil
    override-prime: |
      mkdir -p usr/local/bin
      curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
      install -o root -g root -m 0755 kubectl usr/local/bin/kubectl

  ovn-kubernetes-binaries:
    plugin: nil
    source: .
    source-type: local
    override-prime: |
      mkdir -p usr/bin
      mkdir -p usr/libexec/cni
      mkdir -p root
      mkdir -p etc/openvswitch
      mkdir -p usr/sbin
      
      cp ${CRAFT_PROJECT_DIR}/ovnkube usr/bin/ovnkube
      cp ${CRAFT_PROJECT_DIR}/ovn-kube-util usr/bin/ovn-kube-util
      cp ${CRAFT_PROJECT_DIR}/ovndbchecker usr/bin/ovndbchecker
      cp ${CRAFT_PROJECT_DIR}/hybrid-overlay-node usr/bin/hybrid-overlay-node
      cp ${CRAFT_PROJECT_DIR}/ovnkube-identity usr/bin/ovnkube-identity

      cp ${CRAFT_PROJECT_DIR}/ovn-k8s-cni-overlay usr/libexec/cni/ovn-k8s-cni-overlay

      cp ${CRAFT_PROJECT_DIR}/ovnkube.sh root/ovnkube.sh
      cp ${CRAFT_PROJECT_DIR}/ovndb-raft-functions.sh root/ovndb-raft-functions.sh
      cp ${CRAFT_PROJECT_DIR}/git_info root/git_info

      cp ${CRAFT_PROJECT_DIR}/ovn_k8s.conf etc/openvswitch/ovn_k8s.conf

      cp ${CRAFT_PROJECT_DIR}/iptables-scripts/ip6tables usr/sbin/ip6tables
      cp ${CRAFT_PROJECT_DIR}/iptables-scripts/ip6tables-restore usr/sbin/ip6tables-restore
      cp ${CRAFT_PROJECT_DIR}/iptables-scripts/ip6tables-save usr/sbin/ip6tables-save
      cp ${CRAFT_PROJECT_DIR}/iptables-scripts/iptables usr/sbin/iptables
      cp ${CRAFT_PROJECT_DIR}/iptables-scripts/iptables-restore usr/sbin/iptables-restore
      cp ${CRAFT_PROJECT_DIR}/iptables-scripts/iptables-save usr/sbin/iptables-save

